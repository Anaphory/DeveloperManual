%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Journal Article
% LaTeX Template
% Version 1.4 (15/5/16)
%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original author:
% Frits Wenneker (http://www.howtotex.com) with extensive modifications by
% Vel (vel@LaTeXTemplates.com) and Fabio Mendes (f.mendes@auckland.ac.nz)
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

%\documentclass[oneside,twocolumn]{article}
\documentclass[oneside]{article}

\usepackage{blindtext} % Package to generate dummy text throughout this template 

\usepackage{graphicx} % FKM: for figures
\usepackage{color} % FKM: for colored text
\usepackage{float} % FKM: for forcing figure placement
\usepackage[breakable]{tcolorbox} % FKM: for text box
\usepackage{enumerate} % FKM: for bullet point lists
\usepackage{setspace} % FKM: line spacing
\usepackage[margin=1in]{geometry} % FKM: margins
\usepackage{listings} % FKM: for code windows (lstlisting)
\usepackage{tikz} % FKM: using for \checkmark
\def\checkmark{\tikz\fill[scale=0.4](0,.35) -- (.25,0) -- (1,.7) -- (.25,.15) -- cycle;}

\usepackage[sc]{mathpazo} % Use the Palatino font
\usepackage[T1]{fontenc} % Use 8-bit encoding that has 256 glyphs
% \linespread{1.05} % Line spacing - Palatino needs more space between lines
\usepackage{microtype} % Slightly tweak font spacing for aestheticsgins
\usepackage[small,labelfont=bf,up,up]{caption} % Custom captions under/above floats in tables or figures
\usepackage{booktabs} % Horizontal rules in tables
\usepackage{amsmath} % Text in equations

\usepackage[shortlabels]{enumitem} % customized lists (shortlabels
                                % necessary to have i., ii., etc., in enumerate)
\setlist[itemize]{noitemsep} % Make itemize lists more compact

\usepackage{abstract} % Allows abstract customization
\renewcommand{\abstractnamefont}{\normalfont\bfseries} % Set the "Abstract" text to bold
\renewcommand{\abstracttextfont}{\normalfont\small\itshape} % Set the abstract itself to small italic text

\usepackage{titlesec} % Allows customization of titles

\usepackage{fancyhdr} % Headers and footers
\pagestyle{fancy} % All pages have headers and footers
\fancyhead{} % Blank out the default header
\fancyfoot{} % Blank out the default footer
\fancyhead[C]{Authors et al. $\bullet$ August 2018 $\bullet$ bio{\color{red}R}$\chi$ve} % Custom header text
\fancyfoot[RO,LE]{\thepage} % Custom footer text

\usepackage{titling} % Customizing the title section

\usepackage[hidelinks]{hyperref} % For hyperlinks in the PDF

\usepackage{natbib}
\bibliographystyle{apalike}

\setlength\columnsep{20pt}

\definecolor{pblue}{rgb}{0.13,0.13,1}
\definecolor{pgreen}{rgb}{0,0.5,0}
\definecolor{pred}{rgb}{0.9,0,0}
\definecolor{pgrey}{rgb}{0.46,0.45,0.48}
\definecolor{maroon}{rgb}{0.5,0,0}
\definecolor{darkgreen}{rgb}{0,0.5,0}

\lstset{language=Java,
  showspaces=false,
  showtabs=false,
  breaklines=true,
  showstringspaces=false,
  breakatwhitespace=true,
  commentstyle=\color{pgreen},
  keywordstyle=\color{pblue},
  stringstyle=\color{pred},
  basicstyle=\ttfamily,
  moredelim=[il][\textcolor{pgrey}]{$$},
  moredelim=[is][\textcolor{pgrey}]{\%\%}{\%\%}
}

\lstdefinelanguage{XML}
{
  basicstyle=\ttfamily,
  morestring=[s]{"}{"},
  morecomment=[s]{?}{?},
  morecomment=[s]{!--}{--},
  commentstyle=\color{darkgreen},
  moredelim=[s][\color{black}]{>}{<},
  moredelim=[s][\color{red}]{\ }{=},
  stringstyle=\color{black},
  keywordstyle=\color{black},
  identifierstyle=\color{blue}
}

% \renewcommand{\thepage}{S\arabic{page}}
% \renewcommand{\thesection}{S\arabic{section}}
\renewcommand{\thetable}{S\arabic{table}}
\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\theequation}{S\arabic{equation}}

%----------------------------------------------------------------------------------------
%	TITLE SECTION
%----------------------------------------------------------------------------------------

\setlength{\droptitle}{-4\baselineskip} % Move the title up

\pretitle{\begin{center}\Huge\bfseries} % Article title formatting
\posttitle{\end{center}} % Article title closing formatting
\title{{\huge SUPPLEMENTARY MATERIAL}\\\vspace{.5cm}How to validate your probabilistic model
  implementation} % Article title
\author{\textsc{An author here$^{1,2*}$}, \textsc{Another author
    here$^{1*}$}, \\ \textsc{Yet another author here$^{1*}$},
  \textsc{Last author here$^{1*}$} \\
\small $^1$School of Computer Science, The University of Auckland\\
\small $^2$School of Biological Sciences, The University of Auckland\\
\small
\href{mailto:f.mendes@auckland.ac.nz}{Corresponding authors$^*$: f.mendes@auckland.ac.nz,}
\href{mailto:f.mendes@auckland.ac.nz}{another.email@auckland.ac.nz}
%\and % Uncomment if 2 authors are required, duplicate these 4 lines if more
%\textsc{Jane Smith}\thanks{Corresponding author} \\[1ex] % Second author's name
%\normalsize University of Utah \\ % Second author's institution
%\normalsize \href{mailto:jane@smith.com}{jane@smith.com} % Second author's email address
}
\date{\today} % Leave empty to omit a date
% \renewcommand{\maketitlehookd}{}

%----------------------------------------------------------------------------------------

\doublespacing

\begin{document}

% Print the title
\maketitle

\clearpage
%----------------------------------------------------------------------------------------
%	ARTICLE CONTENTS
%----------------------------------------------------------------------------------------

This text is linked with a live document available on
\href{https://github.com/rbouckaert/DeveloperManual}{https://github.com/rbouckaert/DeveloperManual}.

\section*{Validation procedures in the literature}

The literature on probabilistic modelling in evolutionary biology is vast,
and an exhaustive review of this literature is outside the
scope of the present work. 
We do however provide an extensive list of references that
have implemented (and potentially validated) phylogenetic Bayesian
models (Table \ref{tab:papers}) and other inference components such as
operators.
Each reference was annotated for different validation categories (these
are discussed in the main text).
Our goal was to capture the variation in validation stringency and
comprehensiveness present in this set of computational tools.

We listed references implementing models from the ground
up, meaning that ideally some validation should have been reported in
the manuscript or appendix.
A reference was annotated as having conducted a particular correctness
test if it explicitly mentioned the procedure in the main or
supplementary text, and annotated as ``N/A'' if no validation was mentioned.
Note that ``N/A'' does not mean that validation did not took place,
only that it was not mentioned in the text.
We would hope that unit tests for the likelihood function (item ``i''
in Tab. \ref{tab:papers}), for example, have been implemented in most
if not all of the software we listed.
Alternatively, a reference might belong to a group of several
publications collectively documenting the development of a large
software package, in which case previous work could have documented 
the validation of at least part of the Bayesian inference machinery,
such as MCMC operators.

\begin{center}
  \begin{table}
  \caption{A non-exhaustive list of references from the Bayesian
    phylogenetics literature and the validation procedures explicitly
    mentioned in the main or supplementary text. When no validation
    was mentioned, a reference was annotated as ``N/A''.}
  \label{tab:papers}
  \centering
  \begin{tabular}{ l|c|c|c|c|c|c }
    \hline
    Reference & N/A & i & ii & iii & iv & (a) \\
    \hline
    \citealp{yang97} & & \checkmark & & & & \\
    \citealp{mau99} & & & & \checkmark & & \\
    \citealp{huelsenbeck00} & & & & & & \\
    \citealp{drummond02} & & & \checkmark & & & \checkmark \\
    \citealp{pybus03} & & & & & & \\
    \citealp{lunter03} & & & & & & \\
    \citealp{drummond05} & & & & & & \\
    \citealp{drummond06} & & & & & & \\
    \citealp{best07} & & & & & & \\
    \citealp{than08} & & & & & & \\
    \citealp{heled08} & & & & & & \\
    \citealp{drummond08} & & & & & & \\
    \citealp{lemey09} & & & & & & \\
    \citealp{heled10} & & & & & & \\
    \citealp{drummond10} & & & & & & \\
    \citealp{wu11} & & & & & & \\
    \citealp{liu11} & & & & \checkmark & & \\
    \citealp{eastman11} & & & & \checkmark & & \\
    \citealp{stadler12} & & & & & & \\
    \citealp{heath12a} & & & & & & \\
    \citealp{heath12b} & & & & & & \\
    \citealp{li12} & & & & & & \\
    \citealp{hohna12} & & & & & & \\
    \citealp{heled12} & & & & & & \\
    \citealp{wu13} & & & & & & \\
    \citealp{stadler13} & & & & & & \\
    \citealp{landis13a} & & & & & & \\
    \citealp{landis13b} & & & & & & \\
    \citealp{vaughan14} & & & & & & \\
    \citealp{kuhnert14} & & & & & & \\
    \citealp{gavryushkina14} & & & & & & \\
    \citealp{heath14} & & & & & & \\
    \citealp{popinga15} & & & & & & \\
    \citealp{heled15} & & & & & & \\
    \citealp{uyeda14} & & & & \checkmark & & \\
    \citealp{kuhnert16} & & & & & & \\
    \citealp{kostikova16} & & & & \checkmark & & \\
    \citealp{vaughan17} & & & & & & \\
    \citealp{ogilvie17} & & & & & & \\
    \citealp{bouckaert17} & & & & & \checkmark & \\
    \citealp{zhang17} & & & & & & \\
    \citealp{caetano17} & & & & & & \\
    \citealp{carretero18} & & & & & & \\
    \citealp{du18} & & & & \checkmark & & \\
    \citealp{silvestro19} & & & & \checkmark & & \\
    \hline
  \end{tabular}
  \end{table}
\end{center}

\vspace{-1.5cm}

\section*{Validating the model}
Below we provide code examples for the validation procedures mentioned
in the main text.
The code excerpts are written in Java or xml, as they use BEAST 2
\citep{beast25} model implementations as the reference software being
validated.

\subsection*{Computing the likelihood and comparing against an expected value}

The simplest validation test for a likelihood implementation is to
evaluate the likelihood of a parameter value given some
data, and then compare it to some expected value.
Ideally, the expected value will have been analytically derived from the
model under simple conditions (e.g., a small phylogenetic tree while
equating some of the parameters to zero or unity, etc.).
This forms the basis of what software engineers refer to as ``unit testing''.
We show a unit test example for the Yule model in listing \ref{lst:yuleunit}.

{\small
\vspace{2cm}
\singlespacing
\begin{lstlisting}[language=Java, caption=Java unit test for Yule model
  likelihood function given a small phylogenetic tree.,label={lst:yuleunit}]
  
package test;

import org.junit.Test;
import beast.evolution.speciation.YuleModel;
import beast.util.TreeParser;
import junit.framework.TestCase;

public class YuleLikelihoodTest extends TestCase {
    @Test
    public void testYuleLikelihood() {
        TreeParser tree = new TreeParser("((A:1.0,B:1.0):1.0,(C:1.0,D:1.0):1.0);");
        YuleModel likelihood = new YuleModel();
        likelihood.initByName("tree", tree, "birthDiffRate", "1.0");

        assertEquals(-6.0, likelihood.calculateLogP());
    }
}
\end{lstlisting}
}

As discussed in the main text, another possibility is to use MCMC to
sample from the model without data, and evaluate the resulting
distribution with respect to some analytically derived summary
statistic.
If such quantity has not been derived, one can compare the
distribution sampled with MCMC with a distribution obtained through
direct simulation (i.e., from $S(M)$).
Below, we provide an \texttt{.xml} BEAST 2 control file that carries
out MCMC for the Yule model (listing
\ref{lst:yulemcmc}), using a direct simulator ($S(M)$) as the proposal
mechanism.
The advantage of using a direct simulator to propose new parameter values is
that one can then be sure that problems, if any, involve the model
implementation and not that of the operators. 

{\small
\singlespacing
\begin{lstlisting}[language=XML, caption=BEAST 2 control file for
  sampling a distribution under the Yule model with MCMC (using a
  direct simulator as the proposal mechanism)., label={lst:yulemcmc}]
  
  <beast version="2.0" namespace="beast.core:
  beast.evolution.alignment:
  beast.evolution.tree:
  beast.math.distributions:
  beast.evolution.speciation:
  beast.core.util:
  beast.core.parameter">

  <run spec="MCMC" chainLength="1000000">
    <state id="state">
      <stateNode idref="tree"/>
      <stateNode idref="birthDiffRateParam"/>
    </state>

    <distribution spec="CompoundDistribution" id="fullModel">
      <distribution spec="YuleModel" id="yuleModel">
        <tree spec="Tree" id="tree">
          <taxonset spec="TaxonSet">
            <taxon spec="Taxon" id="t1"/>
            <taxon spec="Taxon" id="t2"/>
            <taxon spec="Taxon" id="t3"/>
            <taxon spec="Taxon" id="t4"/>
            <taxon spec="Taxon" id="t5"/>
          </taxonset>
        </tree>

        <birthDiffRate spec="RealParameter" id="birthDiffRateParam" value="1.0"/>
      </distribution>

      <distribution spec="beast.math.distributions.Prior" id="birthDiffRatePrior">
        <distr spec="Exponential" id="xExpParamDist" mean="1"/>
        <x idref="birthDiffRateParam"/>
      </distribution>
    </distribution>

    <operator spec="beast.experimenter.DirectSimulatorOperator" weight="1" state="@state">
      <simulator id="DirectSimulator" spec="beast.core.DirectSimulator" nSamples="1">
        <distribution idref="fullModel"/>
      </simulator>
    </operator>

    <logger id="tracelog" logEvery="1000" fileName="$(filebase).log">
      <log idref="birthDiffRateParam"/>
      <log id="clockRate" spec="beast.util.Script" expression="0.5/TreeHeight">
        <x id="TreeHeight" spec="beast.evolution.tree.TreeHeightLogger" tree="@tree"/>
      </log>
      <log idref="TreeHeight"/>
    </logger>

    <logger id="treelog" logEvery="1000" fileName="$(filebase).trees">
      <log idref="tree"/>
    </logger>

    <logger id="screenlog" logEvery="1000">
      <log idref="birthDiffRateParam"/>
    </logger>
  </run>
</beast>
\end{lstlisting}
}

The distribution sampled using the control file provided in listing
\ref{lst:yulemcmc} can then be compared to a distribution generated
with a direct simulator.
The control file specifying the latter task is shown in listing
\ref{lst:yuledirect}.

{\small
\singlespacing
\begin{lstlisting}[language=XML, caption=BEAST 2 control file for
  generating a distribution under the Yule model with direct simulation., label={lst:yuledirect}]
  
  <beast version="2.0" namespace="beast.core:
  beast.evolution.alignment:
  beast.evolution.tree:
  beast.math.distributions:
  beast.evolution.speciation:
  beast.core.util:
  beast.core.parameter">

  <run spec="DirectSimulator" nSamples="100">
    <distribution spec="CompoundDistribution" id="fullModel">
    <distribution spec="YuleModel" id="yuleModel">
      <tree spec="Tree" id="tree">
        <taxonset spec="TaxonSet">
          <taxon spec="Taxon" id="t1"/>
          <taxon spec="Taxon" id="t2"/>
          <taxon spec="Taxon" id="t3"/>
          <taxon spec="Taxon" id="t4"/>
          <taxon spec="Taxon" id="t5"/>
        </taxonset>
      </tree>

      <birthDiffRate spec="RealParameter" id="birthDiffRateParam" value="1.0"/>
    </distribution>

    <distribution spec="beast.math.distributions.Prior" id="birthDiffRatePrior">
      <distr spec="Exponential" id="xExpParamDist" mean="1"/>
        <x idref="birthDiffRateParam"/>
      </distribution>

    </distribution>

    <logger logEvery="1" fileName="$(filebase).log">
      <log idref="birthDiffRateParam"/>
      <log id="clockRate" spec="beast.util.Script" expression="0.5/TreeHeight">
        <x id="TreeHeight" spec="beast.evolution.tree.TreeHeightLogger" tree="@tree"/>
      </log>
      <log idref="TreeHeight"/>
    </logger>

    <logger logEvery="1" fileName="$(filebase).trees">
      <log idref="tree"/>
    </logger>
  </run>
</beast>
\end{lstlisting}
}

\subsubsection*{Other validation procedures}

As mentioned in the main text (Box 2), one additional procedure
that can be carried out to validate a model is to verify whether:

\begin{equation}\label{eq:sf}
  \text{E}[U(\theta,D)] = \int U(\theta,D)\text{P}(D|\theta)dD = 0,
\end{equation}

\noindent where $U(\theta,D)=\frac{\partial}{\partial\theta}\log
\text{P}(D|\theta)$ is the gradient of the log-likelihood function with
respect to $\theta$, also known as the score function.

Verifying if Eq. \ref{eq:sf} holds is done by first computing the
integral from multiple directly simulated data points, at one or
more arbitrary coordinate(s) in parameter space.
Second, it should be determined whether the computed value is or not
significantly different from zero, which can be done by fitting two
multivariate normal distributions to it (one with its mean fixed
to 0, the other with an estimated mean).
The fit of those two distributions can then be compared with a
standard likelihood-ratio test with one degree of freedom.

Below, we provide an \texttt{.xml} BEAST 2 control file that carries out the
computation of the integral in Eq. \ref{eq:sf} for the birth-death
model (listing \ref{lst:sf}), and the fitting of multivariate normal distributions.
When executed, this control file will result in a p-value indicating if
the expectation should be considered significantly different from zero
given some chosen significance level.

{\small
\singlespacing
\begin{lstlisting}[language=XML, caption=BEAST 2 control file for
  generating two distributions under the Yule model (one obtained by
  sampling through MCMC and the other with direct simulation)., label={lst:sf}]
  
  <beast version="2.0" namespace="beast:
  beast.core:
  beast.core.parameter:
  beast.evolution.tree:
  beast.evolution.speciation:
  beast.simulation:
  beast.validation:
  beast.validation.statistics:
  beast.validation.tests:
  master.model:
  master.conditions:
  master.postprocessors">

  <run spec="StochasticValidationTest" alpha="0.1" nSamples="10000" printEvery="1000">
    <sampler spec="TreeSamplerFromMaster" verbosity="0" reverseTime="false" simulationTime="3.0" id="masterTree">
      <model spec="Model">
        <population spec="Population" populationName="X" id="X"/>
        <population spec="Population" populationName="D" id="D"/>
        <reaction spec="Reaction" reactionName="Speciation" rate="0.5">
          X -> 2X
        </reaction>
        <reaction spec="Reaction" reactionName="Extinction" rate="0.2">
          X -> D
        </reaction>
      </model>

      <initialState spec="InitState">
        <lineageSeed spec="Individual" population="@X"/>
      </initialState>

      <inheritancePostProcessor spec="LineageFilter" populationName="X"/>
      <inheritancePostProcessor spec="LineageSampler" pSample="0.6" samplingTime="3.0"/>
      <postSimCondition spec="LeafCountPostSimCondition" nLeaves="4" exact="true" />
    </sampler>

    <statistic spec="NumericalScoreFunctionStatistics" state="@masterTree" id="grad">
      <parameter spec="RealParameter" id="birthDiffRate" value="0.3"/>
      <!-- Relative death rate excluded because of non-identifiability -->
      <parameter spec="RealParameter" id="sampleProbability" value="0.6"/>
      <likelihood spec="BirthDeathGernhard08Model" birthDiffRate="@birthDiffRate" relativeDeathRate="0.4" sampleProbability="@sampleProbability" originHeight="3.0" tree="@masterTree" />
    </statistic>

    <test spec="MultivariateNormalZeroMeanTest" id="test"/>

    <sampleLogger spec="Logger" fileName="birth-death-sampling-grad.txt" log="@grad"/>
    <resultLogger spec="Logger" fileName="birth-death-sampling-result.txt" log="@test"/>
    <sampleLogger spec="Logger" fileName="birth-death-sampling-tree.trees" log="@masterTree"/>
  </run>
</beast>
\end{lstlisting}
}

Note that Eq. \ref{eq:sf} should be expected only for parameters
(being differentiated with respect to in the score function) that
do not affect the bounds of integration.
Under the birth-death model, for example, the origin time is a parameter
that determines the bounds of integration for the first speciation
time (i.e., the root), so Eq. \ref{eq:sf} does not hold in this case.

\section*{Validating operators}

[Placeholder for .xml carrying out MCMC under BD]

The posterior distribution sampled with MCMC (as specified by listing X)
can then be compared to a distribution simulated directly from the
birth-death model, as shown in the BEAST 2 control file in listing \ref{lst:bddirect}.


{\small
\singlespacing
\begin{lstlisting}[language=XML, caption=BEAST 2 control file for
  direct simulation of a birth-death model., label={lst:bddirect}]
  
  <beast version="2.0" namespace="beast.core:
  beast.evolution.alignment:
  beast.evolution.tree:
  beast.math.distributions:
  beast.evolution.speciation:
  beast.core.util:
  beast.core.parameter">

  <run spec="MCMC" chainLength="1000000">
    <state id="state">
      <stateNode idref="tree"/>
      <stateNode idref="birthDiffRateParam"/>
    </state>

    <distribution spec="CompoundDistribution" id="fullModel">
      <distribution spec="YuleModel" id="yuleModel">
        <tree spec="Tree" id="tree">
          <taxonset spec="TaxonSet">
            <taxon spec="Taxon" id="t1"/>
            <taxon spec="Taxon" id="t2"/>
            <taxon spec="Taxon" id="t3"/>
            <taxon spec="Taxon" id="t4"/>
            <taxon spec="Taxon" id="t5"/>
          </taxonset>
        </tree>

        <birthDiffRate spec="RealParameter" id="birthDiffRateParam" value="1.0">
      </distribution>

      <distribution spec="beast.math.distributions.Prior" id="birthDiffRatePrior">
        <distr spec="Exponential" id="xExpParamDist" mean="1"/>
          <x idref="birthDiffRateParam"/>
        </distribution>
      </distribution>

      <operator spec="beast.experimenter.DirectSimulatorOperator" weight="1" state="@state">
        <simulator id="DirectSimulator" spec="beast.core.DirectSimulator" nSamples="1">
	  <distribution idref="fullModel"/>
        </simulator>
      </operator>

      <logger id="tracelog" logEvery="1000" fileName="$(filebase).log">
        <log idref="birthDiffRateParam"/>
        <log id="clockRate" spec="beast.util.Script" expression="0.5/TreeHeight">
          <x id="TreeHeight" spec="beast.evolution.tree.TreeHeightLogger" tree="@tree"/>
        </log>
        <log idref="TreeHeight"/>
      </logger>

      <logger id="treelog" logEvery="1000" fileName="$(filebase).trees">
        <log idref="tree"/>
      </logger>

      <logger id="screenlog" logEvery="1000">
        <log idref="birthDiffRateParam"/>
      </logger>
  </run>
</beast>
\end{lstlisting}
}

%----------------------------------------------------------------------------------------
%	REFERENCE LIST
%----------------------------------------------------------------------------------------

\clearpage

\bibliography{refs}

%----------------------------------------------------------------------------------------

\end{document}
